name: Build Test APKs

on:
    push:
        branches: [ "feat/*" ]
    workflow_dispatch:

env:
    GRADLE_OPTS: -Dorg.gradle.jvmargs="-Xmx4g -XX:+HeapDumpOnOutOfMemoryError"

jobs:
    build-test:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up JDK 17
              uses: actions/setup-java@v4
              with:
                  java-version: "17"
                  distribution: "temurin"

            - name: Cache Gradle dependencies
              uses: actions/cache@v4
              with:
                  path: |
                      ~/.gradle/caches
                      ~/.gradle/wrapper
                  key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
                  restore-keys: |
                      ${{ runner.os }}-gradle-

            - name: Make scripts executable
              run: |
                  chmod +x gradlew
                  chmod +x download-agent.sh

            - name: Download agent binaries for all architectures
              run: |
                  echo "Downloading Nezha Agent binaries..."
                  echo "Downloading ARM64 binary..."
                  ./download-agent.sh nezha arm64
                  echo "Downloading ARM32 binary..."
                  ./download-agent.sh nezha arm
                  echo "Downloading X86_64 binary..."
                  ./download-agent.sh nezha amd64
                  echo "Downloading X86 binary..."
                  ./download-agent.sh nezha 386

                  echo "Downloading Komari Agent binaries..."
                  echo "Downloading ARM64 binary..."
                  ./download-agent.sh komari arm64
                  echo "Downloading ARM32 binary..."
                  ./download-agent.sh komari arm
                  echo "Downloading X86_64 binary..."
                  ./download-agent.sh komari amd64
                  echo "Downloading X86 binary..."
                  ./download-agent.sh komari 386

            - name: Build signed release APKs
              env:
                  KEYSTORE_FILE: ${{ secrets.KEYSTORE_FILE }}
                  KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
                  KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
                  KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
              run: |
                  if [ -n "$KEYSTORE_FILE" ]; then
                    echo "Keystore found, building signed release APKs..."
                    echo "$KEYSTORE_FILE" | base64 -d > keystore.jks
                    ./gradlew assembleRelease --stacktrace
                  else
                    echo "No keystore configured, cannot build signed APKs"
                    exit 1
                  fi

            - name: List generated APKs
              run: |
                  echo "Release APKs:"
                  ls -la app/build/outputs/apk/release/

            - name: Get sanitized branch name
              id: branch
              run: |
                BRANCH_NAME="${{ github.ref_name }}"
                # Replace '/' with '-' and remove other invalid characters
                SANITIZED_BRANCH_NAME="${BRANCH_NAME//[\/]/-}"
                SANITIZED_BRANCH_NAME="${SANITIZED_BRANCH_NAME//[^a-zA-Z0-9._-]/}"
                echo "BRANCH_NAME=$SANITIZED_BRANCH_NAME" >> $GITHUB_OUTPUT

            - name: Upload release APKs
              uses: actions/upload-artifact@v4
              with:
                  name: ${{ steps.branch.outputs.BRANCH_NAME }}-release-apks
                  path: app/build/outputs/apk/release/*.apk
                  retention-days: 30